<html>
    <head>
        <title>Sound Visual</title>
        <script src="jquery-3.5.1.min.js"></script>
        <script src="update.js"></script>
        <!-- https://medium.com/swlh/building-a-audio-visualizer-with-javascript-324b8d420e7 -->
    </head>
    
    <body>
        <canvas id="audio_visual" height="500" width="500"></canvas>
        <audio id="source" src="./music/sound.mp3"></audio>

        <button id="clickMe" onclick="start()">Click Me!</button>
        
        <script>
            function start() {
                let canvas = document.getElementById("audio_visual");
                let ctx = canvas.getContext("2d");

                let audioElement = document.getElementById("source");
                
                let audioCtx = new AudioContext();
                let analyser = audioCtx.createAnalyser();
                analyser.fftSize = 2048;
                let source = audioCtx.createMediaElementSource(audioElement);
                   
                source.connect(analyser);

                //this connects our music back to the default output, such as your speakers 
                source.connect(audioCtx.destination);

                let data = new Uint8Array(analyser.frequencyBinCount);

                requestAnimationFrame(loopingFunction);

                function loopingFunction(){
                    requestAnimationFrame(loopingFunction);
                    analyser.getByteFrequencyData(data);
                    draw(data);
                }

                function draw(data){
                    data = [...data];

                    ctx.clearRect(0,0,canvas.width,canvas.height);
                    let space = canvas.width / data.length;
                    data.forEach((value,i)=>{
                        ctx.beginPath();
                        ctx.moveTo(space*i,canvas.height); //x,y
                        ctx.lineTo(space*i,canvas.height-value); //x,y
                        ctx.stroke();
                    })
                }   

                document.getElementById("clickMe").style.display = "none";
            }

            function run() {
                let audioElement = document.getElementById("source");
                audioElement.play();  
            }

            function stop() {
                let audioElement = document.getElementById("source");
                audioElement.pause();
                audioElement.currentTime = 0;
            }
        </script>
        
    </body>
</html>

